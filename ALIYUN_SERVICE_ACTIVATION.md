# 阿里云邮件推送服务激活和配置指南

## 🚀 服务激活步骤

### 第一步：开通邮件推送服务

#### 1.1 登录阿里云控制台

1. 访问 https://ecs.console.aliyun.com
2. 使用您的阿里云账号登录

#### 1.2 开通邮件推送服务

1. 在控制台顶部搜索框输入 **"邮件推送"** 或 **"DirectMail"**
2. 点击进入 **邮件推送** 服务
3. 如果首次使用，会看到 **"立即开通"** 按钮
4. 点击 **"立即开通"** 或 **"开通服务"**

**注意：**
- 首次开通可能需要几分钟时间
- 确保您的账号已完成实名认证
- 确保账号有足够的余额（如果按量付费）

#### 1.3 选择计费方式

阿里云邮件推送通常有两种计费方式：

1. **按量付费**（推荐新手）
   - 按实际发送量计费
   - 通常有免费额度用于测试
   - 适合初期使用

2. **包年包月**
   - 预付费套餐
   - 适合发送量较大的场景

**建议：** 首次使用选择按量付费，先测试功能。

---

## 📧 第二步：配置发件人地址（必须）

**重要：** 在发送邮件之前，必须先配置并验证发件人地址！

### 2.1 进入发件地址管理

1. 在邮件推送控制台，点击左侧菜单 **"发件地址管理"**
2. 点击 **"新建发件地址"** 按钮

### 2.2 选择发件地址类型

您有两种选择：

#### 选项 A：域名发信（推荐）⭐

**优点：**
- 可以使用多个邮箱地址（如 noreply@yourdomain.com, support@yourdomain.com）
- 送达率更高
- 更专业

**步骤：**

1. 选择 **"域名发信"**
2. 输入您的域名（如：`yourdomain.com`）
3. 点击 **"确定"**

**DNS 验证配置：**

系统会要求您添加 DNS 记录，通常包括：

1. **SPF 记录**（必须）
   ```
   类型：TXT
   主机记录：@ 或 yourdomain.com
   记录值：v=spf1 include:spf1.dm.aliyun.com include:spf2.dm.aliyun.com ~all
   ```

2. **DKIM 记录**（推荐）
   ```
   类型：TXT
   主机记录：dm._domainkey 或类似格式
   记录值：[系统会提供具体的值]
   ```

3. **添加 DNS 记录**
   - 登录您的域名管理后台（如阿里云域名、Cloudflare、GoDaddy 等）
   - 添加上述 DNS 记录
   - 等待 DNS 生效（通常几分钟到几小时）

4. **验证域名**
   - 回到阿里云邮件推送控制台
   - 点击 **"验证"** 按钮
   - 等待验证通过

#### 选项 B：邮箱账号发信（简单快速）

**优点：**
- 配置简单，无需 DNS 设置
- 适合快速测试

**缺点：**
- 只能使用单个邮箱地址
- 送达率相对较低

**步骤：**

1. 选择 **"邮箱账号发信"**
2. 输入邮箱地址（如：`noreply@yourdomain.com`）
3. 点击 **"确定"**
4. 系统会发送验证邮件到该邮箱
5. 登录邮箱，点击验证链接
6. 验证通过后即可使用

**注意：**
- 邮箱地址必须是您能接收邮件的地址
- 验证邮件可能在垃圾邮件文件夹中

---

## 🔑 第三步：获取 AccessKey（用于 SMTP 认证）

### 3.1 创建 AccessKey

1. 点击阿里云控制台右上角头像
2. 选择 **"AccessKey 管理"**
3. 如果已有 AccessKey，可以直接使用
4. 如果没有，点击 **"创建 AccessKey"**

**安全建议：**
- ✅ 使用 **子账号** 创建 AccessKey（而非主账号）
- ✅ 只授予必要的权限（邮件推送权限）
- ✅ 妥善保存 AccessKey Secret（只显示一次）

### 3.2 创建子账号（推荐）

**为什么使用子账号？**
- 更安全，避免主账号泄露
- 可以精确控制权限
- 便于管理

**步骤：**

1. 进入 **访问控制（RAM）** 服务
2. 点击 **"用户"** > **"创建用户"**
3. 输入用户名（如：`email-service`）
4. 选择 **"编程访问"**（生成 AccessKey）
5. 点击 **"确定"**
6. **重要：** 复制 AccessKey ID 和 Secret（只显示一次）

### 3.3 授予邮件推送权限

1. 在用户列表中，找到刚创建的用户
2. 点击 **"添加权限"**
3. 搜索 **"AliyunDirectMailFullAccess"** 或 **"邮件推送"**
4. 选择权限策略
5. 点击 **"确定"**

---

## ⚙️ 第四步：查看 SMTP 配置信息

### 4.1 获取 SMTP 服务器地址

在邮件推送控制台：

1. 进入 **"发送设置"** > **"SMTP 设置"**
2. 或查看 **"接入点"** 信息

**标准配置：**

```
SMTP 服务器：smtpdm.aliyun.com
端口：80（HTTP，推荐）或 465（SSL）
```

**不同区域的服务器地址：**

- 中国（杭州）：`smtpdm.aliyun.com`
- 新加坡：`smtpdm-ap-southeast-1.aliyun.com`
- 悉尼：`smtpdm-ap-southeast-2.aliyun.com`
- 美国西部：`smtpdm-us-west-1.aliyun.com`

### 4.2 SMTP 认证信息

```
用户名（SMTP User）：[您的 AccessKey ID]
密码（SMTP Password）：[您的 AccessKey Secret]
```

**重要：**
- 用户名是 AccessKey ID，不是邮箱地址
- 密码是 AccessKey Secret，不是邮箱密码

---

## ✅ 第五步：验证服务是否正常运行

### 5.1 检查服务状态

在邮件推送控制台查看：

1. **服务状态**：应该显示 **"已开通"** 或 **"运行中"**
2. **账户余额**：确保有足够余额（如果按量付费）
3. **发件地址状态**：应该至少有一个 **"已验证"** 的发件地址

### 5.2 发送测试邮件

#### 方法一：在阿里云控制台测试

1. 进入 **"发送记录"** 或 **"测试发送"**
2. 输入测试邮箱地址
3. 输入邮件主题和内容
4. 选择已验证的发件人地址
5. 点击 **"发送"**
6. 检查测试邮箱是否收到邮件

#### 方法二：通过 Supabase 测试

1. 在 Supabase 中配置 SMTP（参考之前的配置指南）
2. 发送测试邮件
3. 检查是否收到

### 5.3 检查发送记录

1. 在邮件推送控制台，进入 **"发送记录"**
2. 查看邮件发送状态：
   - ✅ **发送成功**：邮件已发送
   - ⚠️ **发送失败**：查看失败原因
   - 📊 **统计信息**：查看发送量、送达率等

---

## 🔍 常见问题排查

### Q1: 服务显示"未开通"或"未激活"？

**解决方案：**

1. **检查账号状态**
   - 确认账号已完成实名认证
   - 确认账号没有被限制

2. **重新开通**
   - 点击 **"立即开通"** 按钮
   - 等待几分钟让服务激活

3. **联系客服**
   - 如果一直无法开通，联系阿里云客服

### Q2: 无法创建发件人地址？

**可能原因：**

1. **服务未激活**
   - 确保邮件推送服务已开通

2. **账户余额不足**
   - 检查账户余额（即使有免费额度，也可能需要充值）

3. **域名未备案**（如果使用域名发信）
   - 国内域名可能需要备案
   - 或使用已备案的域名

**解决方案：**
- 先使用 **"邮箱账号发信"** 方式快速测试
- 域名发信可以后续再配置

### Q3: 域名验证失败？

**检查清单：**

- [ ] DNS 记录是否正确添加
- [ ] DNS 记录格式是否正确
- [ ] 等待足够时间让 DNS 生效（通常几分钟到几小时）
- [ ] 使用 `nslookup` 或 `dig` 命令检查 DNS 记录是否生效

**验证 DNS 记录：**

```bash
# Windows
nslookup -type=TXT yourdomain.com

# Linux/Mac
dig TXT yourdomain.com
```

### Q4: 测试邮件发送失败？

**检查清单：**

- [ ] 发件人地址已通过验证
- [ ] AccessKey 有邮件推送权限
- [ ] SMTP 配置信息正确
- [ ] 账户余额充足
- [ ] 没有触发发送限制

**查看错误信息：**

1. 在 **"发送记录"** 中查看失败原因
2. 在 Supabase Auth Logs 中查看错误日志
3. 根据错误信息调整配置

### Q5: 邮件发送成功但收不到？

**可能原因：**

1. **邮件在垃圾邮件文件夹**
   - 检查垃圾邮件/垃圾箱文件夹

2. **邮件被拦截**
   - 某些邮箱服务商可能拦截
   - 尝试使用其他邮箱测试

3. **DNS 配置不完整**
   - 确保 SPF、DKIM 记录都已配置
   - 使用域名发信（而非邮箱账号发信）

---

## 📋 服务激活检查清单

在开始使用服务之前，确认以下项目：

- [ ] ✅ 邮件推送服务已开通
- [ ] ✅ 服务状态显示"运行中"或"已开通"
- [ ] ✅ 至少有一个发件人地址已添加并验证通过
- [ ] ✅ 已创建 AccessKey（ID 和 Secret）
- [ ] ✅ AccessKey 有邮件推送权限
- [ ] ✅ 账户余额充足（如果按量付费）
- [ ] ✅ 已测试发送邮件并成功接收
- [ ] ✅ 知道 SMTP 服务器地址和端口

---

## 🎯 快速启动流程（推荐顺序）

如果您是第一次使用，建议按以下顺序操作：

### 第 1 步：开通服务（5 分钟）
1. 登录阿里云控制台
2. 搜索"邮件推送"
3. 点击"立即开通"
4. 选择按量付费

### 第 2 步：快速测试（10 分钟）
1. 添加邮箱账号发信地址（最简单）
2. 验证邮箱地址
3. 创建 AccessKey
4. 在 Supabase 中配置 SMTP
5. 发送测试邮件

### 第 3 步：正式配置（可选，30 分钟）
1. 配置域名发信（提高送达率）
2. 添加 DNS 记录（SPF、DKIM）
3. 验证域名
4. 更新 Supabase 中的发件人地址

---

## 💡 重要提示

1. **必须先验证发件人地址才能发送邮件**
   - 这是必须的步骤，无法跳过

2. **推荐使用域名发信**
   - 虽然配置复杂，但送达率更高
   - 可以先使用邮箱账号发信测试，后续再配置域名

3. **保存好 AccessKey Secret**
   - 只显示一次，如果丢失需要重新创建

4. **监控发送统计**
   - 定期查看发送记录和统计信息
   - 关注送达率和退信率

5. **遵守发送规范**
   - 避免发送垃圾邮件
   - 遵守相关法律法规

---

## 📞 获取帮助

如果遇到问题：

1. **阿里云工单**
   - 在控制台提交工单
   - 描述具体问题

2. **阿里云文档**
   - 查看官方文档：https://help.aliyun.com/product/29412.html

3. **技术支持**
   - 联系阿里云技术支持

---

完成以上步骤后，您的阿里云邮件推送服务就可以正常对外提供服务了！🎉

