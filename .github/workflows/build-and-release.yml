name: æ„å»ºå’Œå‘å¸ƒ

on:
  # æ‰€æœ‰åˆ†æ”¯çš„ push äº‹ä»¶å’Œ Tag æ¨é€äº‹ä»¶
  push:
    branches:
      - '**'
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æ„å»ºåº”ç”¨
        run: npm run build
        env:
          ELECTRON_MIRROR: https://npmmirror.com/mirrors/electron/

      - name: æå–ç‰ˆæœ¬å·
        id: version
        run: |
          $version = (Get-Content package.json | ConvertFrom-Json).version
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "ç‰ˆæœ¬å·: $version"

      - name: æŸ¥æ‰¾æ„å»ºäº§ç‰©
        id: find-artifact
        run: |
          $exeFile = Get-ChildItem -Path dist -Filter *.exe -Recurse | Select-Object -First 1
          if ($exeFile) {
            $fileName = $exeFile.Name
            $filePath = $exeFile.FullName
            echo "file_name=$fileName" >> $env:GITHUB_OUTPUT
            echo "file_path=$filePath" >> $env:GITHUB_OUTPUT
            echo "æ‰¾åˆ°æ„å»ºäº§ç‰©: $fileName"
          } else {
            echo "é”™è¯¯: æœªæ‰¾åˆ° exe æ–‡ä»¶"
            exit 1
          }

      - name: ä¸Šä¼ åˆ° GitHub Packages
        if: "!startsWith(github.ref, 'refs/tags/')"
        run: |
          $packageName = "todolist-${{ steps.version.outputs.version }}-${{ github.sha }}.exe"
          $packagePath = "${{ steps.find-artifact.outputs.file_path }}"
          
          # é‡å‘½åæ–‡ä»¶
          $newPath = Join-Path (Split-Path $packagePath) $packageName
          Copy-Item $packagePath $newPath -Force
          
          $fileSize = (Get-Item $newPath).Length
          $headers = @{
            "Authorization" = "Bearer ${{ secrets.GITHUB_TOKEN }}"
            "Accept" = "application/vnd.github+json"
            "X-GitHub-Api-Version" = "2022-11-28"
          }
          
          # åˆ›å»º draft release ç”¨äºå­˜å‚¨åˆ° GitHub Packages
          # GitHub Packages ä¼šå­˜å‚¨ Release é™„ä»¶
          $releaseUrl = "https://api.github.com/repos/${{ github.repository }}/releases"
          $releaseBody = @{
            tag_name = "build-${{ github.sha }}"
            name = "Build ${{ steps.version.outputs.version }} - ${{ github.sha }}"
            body = "è‡ªåŠ¨æ„å»ºäº§ç‰©`nç‰ˆæœ¬: ${{ steps.version.outputs.version }}`næäº¤: ${{ github.sha }}`nåˆ†æ”¯: ${{ github.ref_name }}"
            draft = $true
            prerelease = $true
          } | ConvertTo-Json -Compress
          
          try {
            $releaseResponse = Invoke-RestMethod -Uri $releaseUrl -Method Post -Headers $headers -Body $releaseBody -ContentType "application/json"
            $releaseId = $releaseResponse.id
            
            # ä¸Šä¼ æ–‡ä»¶åˆ° Releaseï¼ˆä¼šå­˜å‚¨åœ¨ GitHub Packages ä¸­ï¼‰
            $uploadUrl = "https://uploads.github.com/repos/${{ github.repository }}/releases/$releaseId/assets?name=$packageName"
            $fileContent = [System.IO.File]::ReadAllBytes($newPath)
            
            $uploadHeaders = @{
              "Authorization" = "Bearer ${{ secrets.GITHUB_TOKEN }}"
              "Content-Type" = "application/octet-stream"
            }
            
            Invoke-RestMethod -Uri $uploadUrl -Method Post -Headers $uploadHeaders -Body $fileContent
            
            echo "âœ… å·²ä¸Šä¼ åˆ° GitHub Packages: $packageName"
            echo "ğŸ“¦ Release ID: $releaseId"
            echo "ğŸ”— æŸ¥çœ‹åœ°å€: https://github.com/${{ github.repository }}/releases/tag/build-${{ github.sha }}"
          } catch {
            Write-Error "âŒ ä¸Šä¼ å¤±è´¥: $_"
            if ($_.Exception.Response) {
              $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
              $responseBody = $reader.ReadToEnd()
              Write-Error "å“åº”å†…å®¹: $responseBody"
            }
            exit 1
          }

      - name: ä¿å­˜æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: ${{ steps.find-artifact.outputs.file_path }}
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: æå–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬å·: $VERSION"

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: ./artifacts

      - name: æŸ¥æ‰¾ exe æ–‡ä»¶
        id: find-exe
        run: |
          # æŸ¥æ‰¾æ‰€æœ‰ exe æ–‡ä»¶
          EXE_FILE=$(find artifacts -name "*.exe" -type f | head -n 1)
          if [ -z "$EXE_FILE" ]; then
            echo "é”™è¯¯: æœªæ‰¾åˆ° exe æ–‡ä»¶"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la artifacts/ || true
            exit 1
          fi
          EXE_NAME=$(basename "$EXE_FILE")
          echo "file_name=$EXE_NAME" >> $GITHUB_OUTPUT
          echo "file_path=$EXE_FILE" >> $GITHUB_OUTPUT
          echo "æ‰¾åˆ°æ–‡ä»¶: $EXE_NAME (è·¯å¾„: $EXE_FILE)"

      - name: å‡†å¤‡ Release æ–‡ä»¶
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          NEW_NAME="TodoList-${TAG_NAME}.exe"
          mkdir -p dist
          cp "${{ steps.find-exe.outputs.file_path }}" "dist/$NEW_NAME"
          echo "NEW_NAME=$NEW_NAME" >> $GITHUB_ENV
          echo "å·²å‡†å¤‡æ–‡ä»¶: dist/$NEW_NAME"

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.exe
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## TodoList ${{ steps.version.outputs.version }}
            
            ### ä¸‹è½½
            - [TodoList-${{ github.ref_name }}.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/TodoList-${{ github.ref_name }}.exe)
            
            ### å˜æ›´
            - æŸ¥çœ‹ [æäº¤å†å²](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }})
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

