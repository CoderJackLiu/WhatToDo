# 阿里云邮件推送服务 Supabase 配置指南

## 📋 前置准备

在开始配置之前，请确保您已经：

- ✅ 购买了阿里云邮件推送服务
- ✅ 已开通邮件推送服务
- ✅ 拥有阿里云账号的 AccessKey ID 和 AccessKey Secret
- ✅ 已添加并验证发件人地址（域名或邮箱）

---

## 🔑 第一步：获取 SMTP 配置信息

### 1.1 登录阿里云控制台

1. 访问 https://ecs.console.aliyun.com
2. 登录您的阿里云账号

### 1.2 进入邮件推送服务

1. 在控制台搜索 "邮件推送" 或 "DirectMail"
2. 点击进入 **邮件推送** 服务控制台

### 1.3 查看 SMTP 配置信息

在邮件推送控制台中，您需要找到以下信息：

#### 方法一：通过 SMTP 设置查看

1. 进入 **邮件推送控制台**
2. 点击左侧菜单 **发送设置** > **SMTP 设置**
3. 查看或创建 SMTP 账号

#### 方法二：通过 AccessKey 配置

阿里云邮件推送使用 AccessKey 作为 SMTP 认证信息：

1. 进入 **AccessKey 管理**（右上角头像 > AccessKey 管理）
2. 创建或查看您的 AccessKey ID 和 AccessKey Secret

**重要提示：**
- AccessKey Secret 只显示一次，请妥善保存
- 如果忘记，需要重新创建 AccessKey

---

## 📝 第二步：配置发件人地址

### 2.1 添加发件人地址

1. 在邮件推送控制台，进入 **发件地址管理**
2. 点击 **新建发件地址**
3. 选择地址类型：
   - **域名发信**（推荐）：使用自己的域名，如 `noreply@yourdomain.com`
   - **邮箱账号发信**：使用单个邮箱地址

### 2.2 验证发件人地址

#### 域名发信验证：

1. 选择 **域名发信**
2. 输入您的域名（如：`yourdomain.com`）
3. 按照提示添加 DNS 记录：
   - **SPF 记录**：`v=spf1 include:spf1.dm.aliyun.com include:spf2.dm.aliyun.com ~all`
   - **DKIM 记录**：系统会提供具体的 DKIM 记录值
4. 等待 DNS 验证通过（通常几分钟到几小时）

#### 邮箱账号发信验证：

1. 选择 **邮箱账号发信**
2. 输入邮箱地址（如：`noreply@yourdomain.com`）
3. 系统会发送验证邮件到该邮箱
4. 点击邮件中的验证链接完成验证

---

## ⚙️ 第三步：获取 SMTP 配置参数

### 阿里云邮件推送 SMTP 配置信息

根据您选择的区域，SMTP 服务器地址可能不同：

#### 标准配置（大多数区域）：

```
SMTP Host: smtpdm.aliyun.com
SMTP Port: 80（HTTP）或 465（SSL）或 25（不推荐）
推荐端口: 80 或 465
```

#### 其他可能的服务器地址：

- `smtpdm-ap-southeast-1.aliyun.com`（新加坡区域）
- `smtpdm-ap-southeast-2.aliyun.com`（悉尼区域）
- `smtpdm-us-west-1.aliyun.com`（美国西部区域）

**如何确认您的服务器地址：**
1. 在邮件推送控制台查看 **SMTP 设置**
2. 或查看 **发送设置** > **SMTP 接入点**

### SMTP 认证信息：

```
SMTP User: [您的 AccessKey ID]
SMTP Password: [您的 AccessKey Secret]
```

**注意：**
- 用户名是您的 **AccessKey ID**（不是邮箱地址）
- 密码是您的 **AccessKey Secret**（不是邮箱密码）

---

## 🔧 第四步：在 Supabase 中配置

### 4.1 登录 Supabase Dashboard

1. 访问 https://app.supabase.com
2. 选择您的项目

### 4.2 进入邮件设置

有两种方式进入 SMTP 设置：

#### 方式一：通过 Email Templates

1. 点击左侧菜单 **Authentication**
2. 选择 **Email Templates**
3. 点击任意模板（如 **Confirm signup**）
4. 滚动到底部，找到 **SMTP Settings** 或 **Custom SMTP**
5. 点击 **Enable Custom SMTP** 或 **Configure SMTP**

#### 方式二：通过项目设置

1. 点击左下角 **Settings**（齿轮图标）
2. 选择 **Auth**
3. 找到 **SMTP Settings** 部分
4. 启用 **Custom SMTP**

### 4.3 填写 SMTP 配置

在 Supabase 的 SMTP 配置页面，填写以下信息：

```
┌─────────────────────────────────────────┐
│ SMTP Host                                │
│ smtpdm.aliyun.com                        │
├─────────────────────────────────────────┤
│ SMTP Port                                │
│ 80（推荐）或 465                          │
├─────────────────────────────────────────┤
│ SMTP User                                │
│ [您的 AccessKey ID]                      │
│ 例如：LTAI5txxxxxxxxxxxxx                │
├─────────────────────────────────────────┤
│ SMTP Password                            │
│ [您的 AccessKey Secret]                  │
│ 例如：xxxxxxxxxxxxxxxxxxxxxxxxxxxxx      │
├─────────────────────────────────────────┤
│ Sender Email                             │
│ [已验证的发件人地址]                      │
│ 例如：noreply@yourdomain.com             │
├─────────────────────────────────────────┤
│ Sender Name                              │
│ [发件人名称]                              │
│ 例如：TodoList                           │
└─────────────────────────────────────────┘
```

**配置说明：**

1. **SMTP Host**: `smtpdm.aliyun.com`
   - 如果您的服务在其他区域，使用对应的服务器地址

2. **SMTP Port**: 
   - **推荐使用 80**（HTTP，最简单）
   - 或使用 **465**（SSL，更安全）
   - 避免使用 25 端口（很多服务器会屏蔽）

3. **SMTP User**: 
   - 填写您的 **AccessKey ID**
   - 格式类似：`LTAI5txxxxxxxxxxxxx`

4. **SMTP Password**: 
   - 填写您的 **AccessKey Secret**
   - 格式类似：`xxxxxxxxxxxxxxxxxxxxxxxxxxxxx`

5. **Sender Email**: 
   - 填写您在阿里云中已验证的发件人地址
   - 必须是已验证的地址，否则无法发送

6. **Sender Name**: 
   - 填写发件人显示名称
   - 例如：`TodoList` 或 `您的应用名称`

### 4.4 测试配置

1. 填写完所有信息后，点击 **Test Connection** 或 **Send Test Email**
2. 输入一个测试邮箱地址（建议使用 Gmail 或 Outlook）
3. 点击发送测试邮件
4. 检查测试邮箱是否收到邮件

**测试成功标志：**
- ✅ 连接测试通过
- ✅ 测试邮件成功发送
- ✅ 邮件出现在收件箱（而非垃圾邮件）

### 4.5 保存配置

1. 测试成功后，点击 **Save** 保存配置
2. 配置立即生效

---

## 🔍 第五步：验证配置

### 5.1 在应用中测试

1. 在您的应用中尝试注册新用户
2. 检查是否收到确认邮件
3. 检查邮件是否在收件箱（而非垃圾邮件）

### 5.2 查看发送统计

1. 登录阿里云邮件推送控制台
2. 进入 **发送统计** 查看：
   - 发送数量
   - 送达率
   - 打开率
   - 点击率

### 5.3 查看 Supabase 日志

1. 在 Supabase Dashboard 进入 **Logs** > **Auth Logs**
2. 查看邮件发送相关的日志
3. 确认没有错误信息

---

## ⚠️ 常见问题和解决方案

### Q1: 连接测试失败？

**可能原因和解决方案：**

1. **SMTP Host 错误**
   - 确认使用的是 `smtpdm.aliyun.com`
   - 如果服务在其他区域，使用对应的服务器地址

2. **端口问题**
   - 尝试使用端口 **80**（最简单）
   - 如果 80 不行，尝试 **465**
   - 避免使用 25 端口

3. **AccessKey 错误**
   - 确认 AccessKey ID 和 Secret 正确
   - 检查是否有空格或特殊字符
   - 重新创建 AccessKey 试试

4. **网络问题**
   - 检查服务器是否能访问阿里云 SMTP 服务器
   - 检查防火墙设置

### Q2: 邮件发送失败？

**检查清单：**

- [ ] 发件人地址已通过验证
- [ ] AccessKey 有邮件推送权限
- [ ] 账户余额充足（如果按量付费）
- [ ] 发件人地址格式正确
- [ ] 没有触发频率限制

### Q3: 邮件被标记为垃圾邮件？

**解决方案：**

1. **使用域名发信**（而非邮箱账号发信）
2. **完成域名验证**（SPF、DKIM）
3. **使用专业的发件人名称**
4. **避免使用免费邮箱作为发件人**
5. **邮件内容避免垃圾邮件关键词**

### Q4: 如何查看发送日志？

1. **阿里云控制台**：
   - 邮件推送控制台 > **发送记录**
   - 查看每封邮件的发送状态

2. **Supabase Dashboard**：
   - Logs > Auth Logs
   - 查看认证相关的日志

### Q5: AccessKey 安全吗？

**安全建议：**

1. ✅ 使用 **子账号 AccessKey**（而非主账号）
2. ✅ 只授予必要的权限（邮件推送权限）
3. ✅ 定期轮换 AccessKey
4. ✅ 不要在代码中硬编码 AccessKey
5. ✅ 使用环境变量存储敏感信息

---

## 📊 阿里云邮件推送服务说明

### 计费方式

- **按量付费**：根据发送量计费
- **包年包月**：预付费套餐
- 具体价格请查看阿里云官网

### 发送限制

- **免费额度**：通常有少量免费额度用于测试
- **频率限制**：有发送频率限制，避免滥用
- **日发送量**：根据套餐不同有不同限制

### 功能特性

- ✅ 高送达率
- ✅ 发送统计和分析
- ✅ 支持批量发送
- ✅ 支持模板邮件
- ✅ 国内访问速度快

---

## 🎯 配置完成检查清单

- [ ] 已获取 AccessKey ID 和 Secret
- [ ] 已添加并验证发件人地址
- [ ] 已确认 SMTP 服务器地址和端口
- [ ] 已在 Supabase 中填写所有 SMTP 配置
- [ ] 已成功发送测试邮件
- [ ] 测试邮件出现在收件箱（非垃圾邮件）
- [ ] 已在应用中测试注册功能
- [ ] 确认邮件能正常接收

---

## 📞 获取帮助

如果遇到问题：

1. **阿里云工单**：在阿里云控制台提交工单
2. **Supabase 文档**：https://supabase.com/docs/guides/auth
3. **查看日志**：检查 Supabase Auth Logs 和阿里云发送记录

---

## 💡 最佳实践

1. **使用域名发信**：提高送达率和可信度
2. **完成域名验证**：配置 SPF、DKIM 记录
3. **监控发送统计**：定期查看送达率和退信率
4. **设置合理的发送频率**：避免触发限制
5. **使用专业的发件人名称**：提高用户信任度

---

配置完成后，您的应用就可以使用阿里云邮件推送服务发送邮件了！🎉

